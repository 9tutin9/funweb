<!doctype html>
<html lang="cs">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin — hidden</title>
    <style>
      html, body { margin: 0; padding: 0; height: 100%; font-family: Inter, system-ui, sans-serif; background: #0b0f14; color: #e6f1ff; }
      .wrap { min-height: 100%; display: grid; place-items: center; padding: 24px; }
      .card { width: 100%; max-width: 520px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); }
      h1 { font-size: 18px; margin: 0 0 14px; letter-spacing: 0.2px; color: #b9e6ff; }
      .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 12px; }
      .btn { appearance: none; border: 1px solid rgba(255,255,255,0.18); background: rgba(255,255,255,0.06); color: #e6f1ff; padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600; }
      .btn.primary { background: linear-gradient(145deg,#00d2ff,#007fa8); border: none; }
      .btn:hover { filter: brightness(1.08); }
      .status { font-weight: 700; color: #9be7ff; }
      .field { display: flex; align-items: center; gap: 8px; }
      input[type="password"] { flex: 1; min-width: 0; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.18); color: #e6f1ff; border-radius: 10px; padding: 10px 12px; }
      .hint { opacity: 0.7; font-size: 12px; margin-top: 8px; }
      .ok { color: #67f79a; }
      .err { color: #ff8686; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card" role="region" aria-label="Profile status admin">
        <h1>Admin — profilový status</h1>
        <div class="row" style="margin-bottom:10px">
          <input id="email" type="email" placeholder="Email" autocomplete="username" />
          <input id="password" type="password" placeholder="Heslo" autocomplete="current-password" />
          <button id="login" class="btn primary">Přihlásit</button>
          <button id="logout" class="btn" style="display:none">Odhlásit</button>
        </div>
        <div>Aktuální stav: <span id="status" class="status">…</span></div>

        <div class="row" style="margin-top:16px">
          <button class="btn" data-status="online">Online</button>
          <button class="btn" data-status="away">Nedostupný</button>
          <button class="btn" data-status="offline">Offline</button>
        </div>

        <div class="row" style="margin-top:16px">
          <button id="save" class="btn primary">Uložit</button>
        </div>

        <div id="msg" class="hint" aria-live="polite"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      (function(){
        const sb = window.supabase.createClient(window.SUPABASE_CONFIG.url, window.SUPABASE_CONFIG.anonKey);
        const statusEl = document.getElementById('status');
        const msg = document.getElementById('msg');
        const emailEl = document.getElementById('email');
        const passEl = document.getElementById('password');
        const loginBtn = document.getElementById('login');
        const logoutBtn = document.getElementById('logout');
        let selected = null;

        function setMsg(text, cls){ msg.textContent = text; msg.className = 'hint ' + (cls || ''); }

        async function load(){
          // Try Supabase first if config present
          if (window.SUPABASE_CONFIG && window.SUPABASE_CONFIG.url) {
            try {
              const { data, error } = await sb.from('profile_status').select('status').eq('id', 1).single();
              if(error) throw error;
              statusEl.textContent = data.status || 'online';
              return;
            } catch(_){ /* fallback below */ }
          }
          // Fallback to API
          try {
            const r = await fetch('/api/profile-status', { cache: 'no-store' });
            const j = await r.json();
            statusEl.textContent = j.status || 'online';
          } catch(e){ statusEl.textContent = 'online'; }
        }

        async function saveStatus(){
          try {
            const { error } = await sb.from('profile_status').update({ status: selected, updated_at: new Date().toISOString() }).eq('id', 1);
            if(error) throw error;
            setMsg('Uloženo', 'ok');
            await load();
          } catch(e){ setMsg(String(e.message || e), 'err'); }
        }

        document.querySelectorAll('[data-status]').forEach(btn => {
          btn.addEventListener('click', () => {
            selected = btn.getAttribute('data-status');
            setMsg('Vybrán stav: ' + selected);
          });
        });

        document.getElementById('save').addEventListener('click', async () => {
          if(!selected){ return setMsg('Nejprve vyberte stav', 'err'); }
          // Save via Supabase if available, otherwise fallback to API with Basic auth
          if (window.SUPABASE_CONFIG && window.SUPABASE_CONFIG.url) {
            return saveStatus();
          }
          try {
            const creds = prompt('Zadej ADMIN_USER:ADMIN_PASS (pro dočasný zápis přes API)');
            if(!creds || !creds.includes(':')) throw new Error('Zrušeno');
            const b64 = btoa(creds);
            const r = await fetch('/api/profile-status', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Authorization': 'Basic ' + b64 },
              body: JSON.stringify({ status: selected })
            });
            const j = await r.json();
            if(!r.ok) throw new Error(j.error || 'Chyba');
            setMsg('Uloženo (API)', 'ok');
            await load();
          } catch(e){ setMsg(String(e.message || e), 'err'); }
        });

        async function onLogin(){
          try {
            const email = emailEl.value.trim();
            const password = passEl.value.trim();
            const { error } = await sb.auth.signInWithPassword({ email, password });
            if(error) throw error;
            setMsg('Přihlášeno', 'ok');
            loginBtn.style.display = 'none';
            logoutBtn.style.display = 'inline-flex';
          } catch(e){ setMsg(String(e.message || e), 'err'); }
        }

        async function onLogout(){
          await sb.auth.signOut();
          setMsg('Odhlášeno');
          loginBtn.style.display = 'inline-flex';
          logoutBtn.style.display = 'none';
        }

        loginBtn.addEventListener('click', onLogin);
        logoutBtn.addEventListener('click', onLogout);

        // Reflect auth state on first load
        sb.auth.getSession().then(({ data }) => {
          const has = !!data.session;
          loginBtn.style.display = has ? 'none' : 'inline-flex';
          logoutBtn.style.display = has ? 'inline-flex' : 'none';
        });

        load();
      })();
    </script>
  </body>
</html>


